<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Predicción de Hortofrutícolas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    header {
      background-color: #28a745;
      color: white;
      padding: 10px 0;
    }
    header img {
        height: 40px;
        margin-right: 10px;
    }
  </style>
  <link rel="stylesheet" href="../footer.css">
</head>
<body>
  <header class="d-flex align-items-center px-4">
    <a href="/hortofruticola/gestion_hortofruticola.html">
      <img src="./static/logo.png" alt="Logo Empresa" />
    </a>
    <h1>Predicción de Hortofrutícola para la Próxima Semana</h1>
  </header>

  <div id="app" class="container mt-4">
    <h4>Resultados de la Predicción</h4>

    <div id="contenidoPDF">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock Actual</th>
            <th>Ventas Previstas</th>
            <th>Restock Necesario</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="pred in predicciones" :key="pred.Producto">
            <td>{{ pred.Producto }}</td>
            <td>{{ pred['Stock Actual'] }}</td>
            <td>{{ pred['Ventas previstas'] }}</td>
            <td>{{ pred['Restock necesario'] }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="mb-3">
      <button class="btn btn-success me-2" @click="generarInforme">Generar informe</button>
      <button class="btn btn-info" @click="enviarAhora">Enviar informe por correo</button>
    </div>

    <!-- Modal de éxito -->
    <div class="modal fade" id="modalExito" tabindex="-1" aria-labelledby="modalExitoLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header">
            <h5 class="modal-title w-100" id="modalExitoLabel">¡Informe enviado!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p>El informe se ha enviado con éxito a <strong>{{ correoDestino }}</strong>.</p>
          </div>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="window.history.back()">Volver</button>
  </div>

  <footer>
    <div class="footer-container">
        <!-- Logo PedirIA a la izquierda -->
        <div class="footer-logo-container">
            <img src="../images/logo.png" alt="Logo PedirIA" class="footer-logo">
        </div>

        <!-- Texto de información a la derecha -->
        <div class="footer-info">
            <h3>Trabajo hecho por:</h3>
            <ul>
                <li>Ángela Ausina Sáncehz</li>
                <li>Andrea Belen Cretu Toma</li>
                <li>Alejandro Tendero Ferrandis</li>
                <li>Alejandro Díaz Rivero</li>
                <li>Óscar Renau Pallarés</li>
                <li>Hugo Martí Fernández</li>
            </ul>
        </div>

        <p class="footer-text">PedirIA &copy; 2025. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          predicciones: [],
          correoDestino: ""
        };
      },
      mounted() {
        this.cargarPredicciones();
        this.obtenerCorreoDesdeBackend();
      },
      methods: {
        async cargarPredicciones() {
          try {
              const response = await axios.get("http://localhost:8080/hortofruticolas/stock/prediccion");
              this.predicciones = response.data.message;
          } catch (error) {
              console.error("Error al obtener predicciones:", error);
          }
      },

        async obtenerCorreoDesdeBackend() {
          try {
            const response = await axios.get("http://localhost:8080/comercio/obtener");
            this.correoDestino = response.data;
          } catch (error) {
            console.error("Error al obtener el correo:", error);
          }
        },

        generarInforme() {
          const contenido = document.getElementById("contenidoPDF");
          const fechaActual = new Date();
          const dia = ("0" + fechaActual.getDate()).slice(-2);
          const mes = ("0" + (fechaActual.getMonth() + 1)).slice(-2);
          const anio = fechaActual.getFullYear();
          const nombreArchivo = `informe_hortofruticolas_${dia}${mes}${anio}.pdf`;

          html2pdf()
            .set({
              margin: 1,
              filename: nombreArchivo,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            })
            .from(contenido)
            .save();
        },

        async enviarAhora() {
          const contenido = document.getElementById("contenidoPDF");

          const opt = {
            margin: 1,
            filename: "temp.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
          };

          html2pdf().set(opt).from(contenido).outputPdf('datauristring').then(async (pdfDataUri) => {
            try {
              await axios.post("http://localhost:3000/enviar-informe", {
                destinatario: this.correoDestino,
                pdfBase64: pdfDataUri
              });

              const modal = new bootstrap.Modal(document.getElementById("modalExito"));
              modal.show();
            } catch (error) {
              console.error("Error al enviar el correo:", error);
            }
          });
        }
        
      }
    });

    app.mount("#app");
  </script>
</body>
</html>
